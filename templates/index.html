{% extends "base.html" %}
{% block content %}
<form method="post">
  <label for="identifier">Enter Your Search Term:</label>
  <input
    type="text"
    name="identifier"
    id="identifier"
    placeholder="Enter email, password, domain..."
    required
  />

  <div class="search-type-selector">
    <label><input type="radio" name="search_type" value="leaklookup" checked /> Email/User Breach</label>
    <label><input type="radio" name="search_type" value="hibp_password" /> Password Check</label>
    <label><input type="radio" name="search_type" value="intelx" /> Advanced Search</label>
  </div>

  <div class="form-action">
    <button type="submit" id="submit-button">Search</button>
    <div class="spinner" id="spinner" style="display:none"></div>
  </div>
</form>

{% if error %}
<div class="error-message">{{ error }}</div>
{% endif %}

{% if results %}
  <!-- === Results Section === -->
  <div class="result" id="result-container">
    {% if results.search_type == 'hibp_password' %}
      <!-- üîê Password Breach Result -->
      <div class="password-result" style="background-color:#161b22;padding:20px;border-radius:10px;color:#fff;">
        <h3 style="color:#58a6ff;">üîê Password Check Result</h3>
        {% if results.error %}
          <p class="error" style="color:#f85149;">‚ö†Ô∏è Error: {{ results.error }}</p>
        {% elif results.breached %}
          <h4 style="color:#ff7b72;">üö® Password Found in Breaches!</h4>
          <p>This password appeared <strong>{{ results.count }}</strong> times in known data breaches.</p>
          <ul style="list-style-type:disc;margin-left:25px;">
            <li>Change this password immediately on all platforms.</li>
            <li>Do not reuse passwords across accounts.</li>
            <li>Use a password manager and enable MFA for better protection.</li>
          </ul>
        {% else %}
          <h4 style="color:#3fb950;">‚úÖ Good news!</h4>
          <p>This password has <strong>not</strong> been found in any known data breach.</p>
          <p>Still, always use strong, unique passwords and MFA for safety.</p>
        {% endif %}
      </div>

    {% else %}
      <!-- üåê Breach Mind Map Visualization -->
      <div id="jsmind_container"
           style="width:100%;height:550px;border-radius:10px;
                  background-color:#0d1117;color:#fff;overflow:auto;">
      </div>
    {% endif %}
  </div>

  <!-- üõ°Ô∏è General Mitigation Section -->
  <div class="general-mitigations" style="margin-top:30px;background-color:#161b22;
       padding:20px;border-radius:10px;color:#fff;">
    <h3 style="color:#58a6ff;">üõ°Ô∏è General Prevention & Mitigation Guidelines</h3>
    <ul style="list-style-type:disc;margin-left:25px;">
      {% for tip in general_mitigations %}
        <li style="margin:8px 0;">{{ tip }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<!-- === Recent History === -->
<div class="history">
  <h3>Recent Checks</h3>
  <ul>
    {% for row in history %}
    <li>
      <span class="history-identifier">{{ row.identifier }}</span>
      <span class="history-search-type">({{ row.search_type }})</span> ‚Üí
      {% if 'Found' in row.summary %}
      <span class="breached">{{ row.summary }}</span>
      {% else %}
      <span class="safe">{{ row.summary }}</span>
      {% endif %}
      <small class="timestamp">({{ row.timestamp }})</small>
    </li>
    {% else %}
    <li>No checks performed yet.</li>
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
  // === Spinner on submit ===
  document.querySelector("form")?.addEventListener("submit", () => {
    document.getElementById("submit-button").style.display = "none";
    document.getElementById("spinner").style.display = "block";
  });
</script>

{% if results %}
<script>
function buildMindMap(data){
  const container=document.getElementById("jsmind_container");
  if(!container) return;
  container.innerHTML="";

  const mindData={
    meta:{name:"Breach Results"},
    format:"node_tree",
    data:{id:"root",topic:data.identifier,children:[], "background-color":"#161b22"}
  };

  if(data.breached && data.sources?.length){
    const icons={high:"üî•",medium:"‚ö†Ô∏è",low:"‚ÑπÔ∏è"};
    data.sources.forEach((src,i)=>{
      const id="b"+i;
      const risk=(src.risk_level||"low").toLowerCase();
      const icon=icons[risk]||"‚ÑπÔ∏è";
      const node={id,topic:`${icon} ${src.name}`,direction:"right",children:[],data:{}};

      if(src.date && src.date!=="N/A") node.children.push({id:id+"_d",topic:"üóìÔ∏è "+src.date});
      if(src.breach_classification) node.children.push({id:id+"_c",topic:"üìÇ "+src.breach_classification});
      if(src.description) node.children.push({id:id+"_desc",topic:src.description});
      if(src.data_classes?.length){
        const dNode={id:id+"_data",topic:"üß© Exposed Data",children:[]};
        src.data_classes.forEach((dc,j)=>dNode.children.push({id:id+"_dc_"+j,topic:dc}));
        node.children.push(dNode);
      }
      mindData.data.children.push(node);
    });
  } else {
    mindData.data.children.push({
      id:"safe",
      topic:"‚úÖ No breaches found!",
      "background-color":"#3fb950"
    });
  }

  const jm=new jsMind({container:"jsmind_container",editable:false,theme:"primary"});
  jm.show(mindData);
}

// === Render on DOM Ready ===
document.addEventListener("DOMContentLoaded",()=>{
  const data={{ results|tojson|safe }};
  if(!data) return;
  if(data.search_type!=="hibp_password"){
    buildMindMap(data);
  }
});
</script>
{% endif %}
{% endblock %}
