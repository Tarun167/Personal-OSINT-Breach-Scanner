{% extends "base.html" %}

{% block content %}
<form method="post">
    <label for="identifier">Enter Your Search Term:</label>
    <input
        type="text"
        name="identifier"
        id="identifier"
        placeholder="Enter email, password, domain..."
        required
    />

    <div class="search-type-selector">
        <label><input type="radio" name="search_type" value="leaklookup" checked> Email/User Breach</label>
        <label><input type="radio" name="search_type" value="hibp_password"> Password Check</label>
        <label><input type="radio" name="search_type" value="intelx"> Advanced Search</label>
    </div>

    <div class="form-action">
        <button type="submit" id="submit-button">Search</button>
        <div class="spinner" id="spinner" style="display: none;"></div>
    </div>
</form>

{% if results %}
<div class="result" id="result-container">
    {# Content is generated by JavaScript below #}
</div>
{% endif %}

<div class="history">
    <h3>Recent Checks</h3>
    <ul>
        {% for row in history %}
        <li>
            <span class="history-identifier">{{ row.identifier }}</span> 
            <span class="history-search-type">({{ row.search_type }})</span>
            → 
            {% if 'Found' in row.summary %}
                <span class="breached">{{ row.summary }}</span>
            {% else %}
                <span class="safe">{{ row.summary }}</span>
            {% endif %}
            <small class="timestamp">({{ row.timestamp }})</small>
        </li>
        {% else %}
        <li>No checks performed yet.</li>
        {% endfor %}
    </ul>
</div>
{% endblock %}


{% block scripts %}

<script>
    // Spinner logic - always available
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            document.getElementById('submit-button').style.display = 'none';
            document.getElementById('spinner').style.display = 'block';
        });
    }
</script>

{% if results %}
<script type="text/javascript">
    
    function displayPasswordResult(data) {
        const container = document.getElementById('result-container');
        let html = '<h3>Password Check Result</h3>';
        if (data.breached) {
            const count = data.count.toLocaleString();
            html += `<p><span class="breached">⚠️ This password was found ${count} times in data breaches.</span></p>`;
            html += `<p>You should absolutely not use this password anywhere.</p>`;
        } else {
            html += `<p><span class="safe">✅ Good news—this password was not found!</span></p>`;
        }
        container.innerHTML = html;
        container.style.height = 'auto'; // Let the content define the height
    }

    function buildMindMap(data) {
        const container = document.getElementById('result-container');
        // Clear container and add the jsmind div
        container.innerHTML = '<div id="jsmind_container"></div>'; 

        let mindMapData = {
            "meta": { "name": "Breach Results", "author": "Personal OSINT Dashboard" },
            "format": "node_tree",
            "data": { "id": "root", "topic": data.identifier, "children": [], "class-name": "root-node" }
        };

        if (data.breached && data.sources) {
            mindMapData.data.direction = "right";
            
            data.sources.forEach((source, index) => {
                const breachId = "breach" + index;
                const breachNode = {
                    "id": breachId,
                    "topic": source.name,
                    "direction": "right",
                    "children": [],
                    "class-name": "breach-title"
                };

                if (source.date && source.date !== "N/A") {
                    breachNode.children.push({ "id": breachId + "_date", "topic": "Date: " + source.date });
                }

                if (source.description) {
                    breachNode.children.push({ "id": breachId + "_desc", "topic": source.description, "class-name": "breach-desc" });
                }

                if (source.compromised_data && source.compromised_data.length > 0) {
                    const dataNode = { "id": breachId + "_data", "topic": "Compromised Data", "children": [] };
                    source.compromised_data.forEach((item, item_index) => {
                        dataNode.children.push({ "id": breachId + "_data_" + item_index, "topic": item, "class-name": "leaf-node" });
                    });
                    breachNode.children.push(dataNode);
                }
                mindMapData.data.children.push(breachNode);
            });
        } else {
            mindMapData.data["background-color"] = "#3fb950";
            mindMapData.data.children.push({ "id": "safe_node", "topic": "✅ No breaches found!" });
        }

        const options = {
            container: 'jsmind_container',
            editable: false,
            theme: 'primary'
        };
        const jm = new jsMind(options);
        jm.show(mindMapData);

        const jmContainer = document.getElementById('jsmind_container');
        const nodes = jmContainer.querySelectorAll('jmnode');
        
        nodes.forEach((node, index) => {
            node.style.transitionDelay = `${index * 80}ms`;
        });

        setTimeout(() => { jmContainer.classList.add('loaded'); }, 10);
    }

    // --- Main Controller Function ---
    document.addEventListener('DOMContentLoaded', function() {
        const resultData = {{ results|tojson|safe }};
        if (!resultData) return;

        if (resultData.search_type === 'hibp_password') {
            displayPasswordResult(resultData);
        } else {
            buildMindMap(resultData);
        }
    });
</script>
{% endif %}

{% endblock %}